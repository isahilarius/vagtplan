<!DOCTYPE html>
<html lang="da">
  <head>
    <meta charset="utf-8" />
    <title>Vagtskema Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.cdnfonts.com/css/flama" rel="stylesheet" />

    <style>
      body {
        font-family: "Flama", sans-serif;
        background: #f2f2f2;
        padding: 24px;
        color: white;
      }
      .logo {
        display: flex;
        justify-content: center;
        padding-bottom: 30px;
      }
      .logo img {
        max-width: 15em;
      }
      .card {
        background: #171c40;
        padding: 18px;
        border-radius: 10px;
        max-width: 900px;
        margin: auto;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      }
      h1 {
        margin: 0 0 12px 0;
        font-size: 20px;
      }
      .controls {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
      }
      input[type="date"] {
        padding: 8px;
        border-radius: 6px;
        border: none;
        font-family: "Flama", sans-serif;
      }
      button {
        padding: 8px 14px;
        background: #e09e40;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-family: "Flama", sans-serif;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }
      th {
        background: #292d4e;
      }
      .note {
        color: white;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="logo">
      <img src="images/logo.webp" alt="Hovedstadens Beredskabs logo" />
    </div>
    <div id="app" class="card">
      <h1>Vagtskema - Oversigt</h1>

      <div class="controls">
        <input type="date" v-model="date" />
        <button @click="refresh">Se vagtskema</button>
      </div>

      <div v-if="loading">Henter...</div>
      <div v-if="error" style="color: darkred">{{ error }}</div>

      <table v-if="stations.length && !loading">
        <thead>
          <tr>
            <th>Station</th>
            <th>Aktiv gruppe (kl. 8.00)</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="s in stations" :key="s.id">
            <td>{{ s.name }}</td>
            <td v-if="groups[s.id]">{{ groups[s.id].group }}</td>
            <td v-else>â€”</td>
            <td v-if="groups[s.id]">{{ groups[s.id].reason }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            apiUrl: "http://localhost:8000/api.php",
            date: new Date().toISOString().slice(0, 10),
            stations: [],
            groups: {},
            loading: false,
            error: "",
          };
        },
        mounted() {
          this.loadStations();
        },
        methods: {
          async loadStations() {
            try {
              const res = await fetch(`${this.apiUrl}?endpoint=stations`);
              const data = await res.json();

              if (!Array.isArray(data)) {
                throw new Error("Stations fetch returnerede ikke et array");
              }

              this.stations = data;
              this.refresh();
            } catch (e) {
              this.error =
                "Kunne ikke hente stations. Start php-serveren (php -S localhost:8000) eller tjek API: " +
                e;
            }
          },
          async refresh() {
            this.loading = true;
            this.groups = {};
            this.error = "";
            try {
              // hent gruppe for hver station parallelt
              const promises = this.stations.map((s) =>
                fetch(
                  `${this.apiUrl}?endpoint=group&stationId=${s.id}&date=${this.date}`
                )
                  .then((r) =>
                    r.ok
                      ? r.json()
                      : r.text().then((t) => {
                          throw t;
                        })
                  )
                  .then((data) => ({ id: s.id, data }))
              );
              const results = await Promise.all(promises);
              results.forEach((r) => (this.groups[r.id] = r.data));
            } catch (err) {
              this.error = "Fejl ved hent af grupper: " + err;
            } finally {
              this.loading = false;
            }
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
