<!DOCTYPE html>
<html lang="da">
  <head>
    <meta charset="utf-8" />
    <title>Vagtskema Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.cdnfonts.com/css/flama" rel="stylesheet" />
    <link rel="stylesheet" href="/app.css" />
  </head>
  <body class="font-flama bg-gray-200 text-white p-6">
    <!-- Logo -->
    <div class="flex justify-center pb-8">
      <img
        src="images/logo.webp"
        alt="Hovedstadens Beredskabs logo"
        class="max-w-[15em]"
      />
    </div>
    <h1 class="text-4xl text-red-500 font-flama">Test Tailwind</h1>

    <!-- Card -->
    <div
      id="app"
      class="bg-darkblue p-5 rounded-xl max-w-3xl mx-auto shadow-md"
    >
      <h1 class="text-2xl mb-3 font-flama">Vagtskema - Oversigt</h1>

      <!-- Controls -->
      <div class="flex gap-3 mb-3">
        <input
          type="date"
          v-model="date"
          class="px-3 py-2 rounded-md border-none text-black font-flama"
        />
        <button
          @click="refresh"
          class="px-4 py-2 bg-orange rounded-md text-white cursor-pointer font-flama hover:bg-yellow-500"
        >
          Se vagtskema
        </button>
      </div>

      <!-- Table -->
      <table
        v-if="stations.length && !loading"
        class="w-full border-collapse mt-2 text-white"
      >
        <thead>
          <tr class="bg-darkerblue">
            <th class="px-3 py-2 text-left">Station</th>
            <th class="px-3 py-2 text-left">Aktiv gruppe (kl. 8.00)</th>
            <th class="px-3 py-2 text-left">Note</th>
          </tr>
        </thead>
        <tbody>
          <tr
            v-for="s in stations"
            :key="s.id"
            class="border-b border-gray-500"
          >
            <td class="px-3 py-2">{{ s.name }}</td>
            <td class="px-3 py-2" v-if="groups[s.id]">
              {{ groups[s.id].group }}
            </td>
            <td class="px-3 py-2" v-else>â€”</td>
            <td class="px-3 py-2" v-if="groups[s.id]">
              {{ groups[s.id].reason }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            apiUrl: "http://localhost:8000/api.php",
            date: new Date().toISOString().slice(0, 10),
            stations: [],
            groups: {},
            loading: false,
            error: "",
          };
        },
        mounted() {
          this.loadStations();
        },
        methods: {
          async loadStations() {
            try {
              const res = await fetch(`${this.apiUrl}?endpoint=stations`);
              const data = await res.json();

              if (!Array.isArray(data)) {
                throw new Error("Stations fetch returnerede ikke et array");
              }

              this.stations = data;
              this.refresh();
            } catch (e) {
              this.error =
                "Kunne ikke hente stations. Start php-serveren (php -S localhost:8000) eller tjek API: " +
                e;
            }
          },
          async refresh() {
            this.loading = true;
            this.groups = {};
            this.error = "";
            try {
              // hent gruppe for hver station parallelt
              const promises = this.stations.map((s) =>
                fetch(
                  `${this.apiUrl}?endpoint=group&stationId=${s.id}&date=${this.date}`
                )
                  .then((r) =>
                    r.ok
                      ? r.json()
                      : r.text().then((t) => {
                          throw t;
                        })
                  )
                  .then((data) => ({ id: s.id, data }))
              );
              const results = await Promise.all(promises);
              results.forEach((r) => (this.groups[r.id] = r.data));
            } catch (err) {
              this.error = "Fejl ved hent af grupper: " + err;
            } finally {
              this.loading = false;
            }
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
